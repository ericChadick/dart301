[gd_scene format=3 uid="uid://hyeh47v46j86"]

[ext_resource type="Script" uid="uid://bl44lp1yridj8" path="res://Enemies/enemy.gd" id="4_55wc7"]
[ext_resource type="PackedScene" uid="uid://balgpgdnfqd4g" path="res://Enemies/Enemie1/Drone.fbx" id="4_bghym"]
[ext_resource type="Script" uid="uid://bb0t2ovl7wifo" path="res://addons/beehave/nodes/beehave_tree.gd" id="6_55wc7"]
[ext_resource type="Script" uid="uid://cg016dbe7gs1x" path="res://addons/beehave/nodes/composites/sequence.gd" id="6_br3nj"]
[ext_resource type="Script" uid="uid://8hn4kne15ac5" path="res://addons/beehave/nodes/composites/selector.gd" id="7_j0tst"]

[sub_resource type="GDScript" id="GDScript_xn6gn"]
script/source = "@tool
extends ConditionLeaf

@export_range(0, 100, 1, \"suffix:%\") var health_percentage: int = 30

func tick(actor: Node, _blackboard: Blackboard) -> int:
	var enemy := actor as Enemy
	if enemy == null:
		return FAILURE

	if enemy.max_health <= 0:
		return FAILURE

	var hp_percent := (float(enemy.health) / float(enemy.max_health)) * 100.0
	return SUCCESS if hp_percent < float(health_percentage) else FAILURE
"

[sub_resource type="GDScript" id="GDScript_bghym"]
script/source = "@tool
extends ConditionLeaf
class_name CanSeePlayer_BH

@export var vision_range: float = 25.0
@export var fov_degrees: float = 90.0
@export var collision_mask: int = 1  # world geometry layer(s)

func tick(actor: Node, blackboard: Blackboard) -> int:
	var enemy := actor as Enemy
	if enemy == null:
		return FAILURE

	var player := enemy.get_tree().get_first_node_in_group(\"player\") as Node3D
	if player == null:
		return FAILURE

	# Eye positions
	var from := enemy.global_position + Vector3.UP * enemy.eye_height
	var to := player.global_position + Vector3.UP * 1.2

	# Range check
	if from.distance_to(to) > vision_range:
		return FAILURE

	# FOV check (uses enemy forward)
	var to_player_dir := (to - from).normalized()
	var forward := -enemy.global_transform.basis.z.normalized()
	var cos_half_fov := cos(deg_to_rad(fov_degrees * 0.5))
	if forward.dot(to_player_dir) < cos_half_fov:
		return FAILURE

	# Raycast (line of sight)
	var space := enemy.get_world_3d().direct_space_state
	var query := PhysicsRayQueryParameters3D.create(from, to)
	query.collision_mask = collision_mask
	query.exclude = [enemy]  # don't hit yourself

	var hit := space.intersect_ray(query)

	# If something blocks, you can't see the player
	if hit.size() > 0:
		var collider: Object = hit[\"collider\"]
		if collider != player and not (collider is Node and (collider as Node).is_in_group(\"player\")):
			return FAILURE

	# SUCCESS: store last seen position for chasing/searching
	blackboard.set_value(\"last_seen_pos\", player.global_position)
	blackboard.set_value(\"has_last_seen\", true)
	return SUCCESS
"

[sub_resource type="BoxShape3D" id="BoxShape3D_ffrie"]
size = Vector3(2.1970215, 2.2486572, 2.7003174)

[node name="TestEnemy_tscn" type="Node3D" unique_id=1924405938]

[node name="Enemy" type="CharacterBody3D" parent="." unique_id=1538566187]
script = ExtResource("4_55wc7")

[node name="Visual2" type="Node3D" parent="Enemy" unique_id=775212031]

[node name="Drone" parent="Enemy/Visual2" unique_id=1041426428 instance=ExtResource("4_bghym")]
transform = Transform3D(0.9999999, 0, 0, 0, 1, 0, 0, 0, 0.9999999, 0, 2, 0)

[node name="BeehaveTree" type="Node" parent="Enemy" unique_id=460015067 node_paths=PackedStringArray("blackboard", "actor")]
script = ExtResource("6_55wc7")
blackboard = NodePath("@Node@25610")
actor = NodePath("")
metadata/_custom_type_script = "uid://bb0t2ovl7wifo"

[node name="SelectorComposite2" type="Node" parent="Enemy/BeehaveTree" unique_id=343080693]
script = ExtResource("7_j0tst")
metadata/_custom_type_script = "uid://8hn4kne15ac5"

[node name="SequenceComposite" type="Node" parent="Enemy/BeehaveTree/SelectorComposite2" unique_id=627913226]
script = ExtResource("6_br3nj")
metadata/_custom_type_script = "uid://cg016dbe7gs1x"

[node name="HealthLess30Percent" type="Node" parent="Enemy/BeehaveTree/SelectorComposite2/SequenceComposite" unique_id=704449503]
script = SubResource("GDScript_xn6gn")

[node name="RetreatFromPlayer" type="Node" parent="Enemy/BeehaveTree/SelectorComposite2/SequenceComposite" unique_id=1263759097]
script = SubResource("GDScript_bghym")
vision_range = null
fov_degrees = null
collision_mask = null

[node name="MoveAtPlayer" type="Node" parent="Enemy/BeehaveTree/SelectorComposite2" unique_id=1632718790]
script = SubResource("GDScript_bghym")
vision_range = null
fov_degrees = null
collision_mask = null

[node name="CollisionShape3D" type="CollisionShape3D" parent="Enemy" unique_id=1771231787]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.023803711, 2.0885878, 0.02935791)
shape = SubResource("BoxShape3D_ffrie")

[node name="NavigationAgent3D" type="NavigationAgent3D" parent="Enemy" unique_id=1041459957]
